<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÅ‡∏ü‡∏ô‡∏ã‡∏µ - ‡πÄ‡∏Å‡∏°‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ (Full Compact)</title>
<style>
  :root{
    --bg: #041422;
    --panel: #071827;
    --accent: #8b5cf6;
    --muted: #9fb4c8;
    --board-size: 420px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
    --cell-gap: 3px;
    --token-size: 16px;
    --font-base: 13px;
  }
  *{box-sizing:border-box;font-family: "Noto Sans Thai", Inter, system-ui, -apple-system, Roboto, sans-serif}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    background: linear-gradient(180deg,#021018,#072034);
    color:#e6eef8;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:18px;
    font-size:var(--font-base);
  }
  .wrap{
    width:1080px;
    max-width:100%;
    display:grid;
    grid-template-columns: var(--board-size) 1fr;
    gap:18px;
    align-items:start;
  }
  .board-wrap{
    background: linear-gradient(180deg,#071827,#041424);
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.03);
    position:relative;
  }
  .board{
    width:var(--board-size);
    height:var(--board-size);
    display:grid;
    grid-template-columns: repeat(9, 1fr);
    grid-template-rows: repeat(9, 1fr);
    gap: var(--cell-gap);
    padding:6px;
    border-radius:8px;
    background: linear-gradient(180deg,#051223,#02121a);
  }
  .cell{
    background: linear-gradient(180deg,#0b1723,#06111a);
    border-radius:6px;
    padding:6px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    color:#cfe7ff;
    font-size:12px;
    position:relative;
    overflow:visible;
    min-height:0;
  }
  .cell.blank { background: transparent; border:none; }
  .cell.corner{ background: linear-gradient(180deg,#f59e0b,#b45309); color:#081018; font-weight:800; display:grid; place-items:center; padding:4px; font-size:13px; }
  .title{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .price{ font-size:11px; color:#bfe3ff; }
  .tokens{ position:absolute; left:6px; bottom:6px; display:flex; gap:4px; z-index:6; }
  .token{ width:var(--token-size); height:var(--token-size); border-radius:50%; display:inline-grid; place-items:center; font-size:10px; color:#fff; border:2px solid rgba(0,0,0,0.35); }
  .p1{ background:#ef4444 } .p2{ background:#3b82f6 }
  .owner-mark{ position:absolute; right:6px; top:6px; padding:2px 6px; border-radius:6px; font-size:11px; background:rgba(0,0,0,0.45) }
  .house-mark{ position:absolute; left:6px; top:6px; padding:2px 6px; border-radius:6px; font-size:12px; background:rgba(255,255,255,0.06) }
  .panel{ display:flex; flex-direction:column; gap:12px; }
  .card{ background: linear-gradient(180deg,#051222,#03101a); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03) }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button{ background: var(--accent); border:none; padding:8px 12px; border-radius:8px; font-weight:700; color:#fff; cursor:pointer; font-size:13px; }
  button.secondary{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted) }
  .log{ height:260px; overflow:auto; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); font-size:13px; }
  .players{ display:flex; flex-direction:column; gap:8px; }
  .player{ display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); font-size:13px; }
  .small{ font-size:12px; color:var(--muted); }
  .die{ width:40px; height:40px; border-radius:6px; background:#0b1220; display:grid; place-items:center; font-size:18px; border:1px solid rgba(255,255,255,0.03) }
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999; padding:12px; }
  .modal{ background:linear-gradient(180deg,#081427,#04111a); padding:16px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); width:360px; color:#e6eef8; }
  .modal h3{ margin:0 0 8px 0; font-size:16px }
  .center-note{ position:absolute; left:50%; transform:translateX(-50%); top:8px; background:rgba(0,0,0,0.45); padding:6px 10px; border-radius:8px; font-weight:700; z-index:8; font-size:13px; display:none; }
  .prop-list{ max-height:120px; overflow:auto; margin-top:6px; font-size:13px }
  .prop-item{ padding:6px; border-radius:6px; background:rgba(255,255,255,0.02); margin-bottom:6px; }
  @media(max-width:1100px){
    .wrap{ grid-template-columns:1fr; padding-bottom:30px; }
    .board{ width:86vw; height:86vw; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="board-wrap">
      <div id="board" class="board"></div>
      <div id="centerNote" class="center-note"></div>

      <!-- Modal -->
      <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
        <div class="modal">
          <h3 id="modal-title">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
          <div id="modal-body" style="white-space:pre-wrap;margin-top:8px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="modal-cancel" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button id="modal-ok">‡∏ï‡∏Å‡∏•‡∏á</button>
          </div>
        </div>
      </div>

    </div>

    <div class="panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div id="currentPlayer" style="font-weight:800;font-size:16px">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
          </div>
          <div>
            <div class="small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div id="status" style="font-weight:700">‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
          </div>
        </div>

        <div style="margin-top:10px" class="controls">
          <div style="display:flex;gap:8px;align-items:center">
            <div class="die" id="die1">-</div>
            <div class="die" id="die2">-</div>
          </div>
          <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
          <button id="rollBtn" disabled>‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤</button>
          <button id="endBtn" class="secondary" disabled>‡∏à‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</button>
          <button id="buyBtn" class="secondary" disabled>‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà</button>
          <button id="upgradeBtn" class="secondary" disabled>‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
          <button id="freeTripBtn" class="secondary" disabled>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</button>
        </div>
      </div>

      <div class="card">
        <div class="small">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
        <div class="players" id="players"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
          <div id="diceSum" class="small">-</div>
        </div>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <div class="small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</div>
        <div id="propList" class="prop-list"></div>
      </div>

      <div class="card" style="text-align:center;font-size:12px;color:var(--muted)">Designed by Chester</div>
    </div>
  </div>

<script>
/* ===========================
   Fantasy Monopoly ‚Äî Compact Full Version (Thai)
   - 9x9 outer ring (32 playable slots)
   - properties (buy/upgrade/rent)
   - treasure & fate cards
   - tax / jail / free trip
   - animated move, 2 dice
   - pass Start +200, land Start +300
   - must pass Start once before buying (hasPassedStart)
   - modal popup with buy/confirm options
   - AI opponent
   - roll locked after player roll; player must press End Turn
   =========================== */

const START_BONUS_PASS = 200;
const START_BONUS_LAND = 300;
const INITIAL_MONEY = 1500;
const ANIM_STEP_MS = 160; // animation speed (ms per step)
const JAIL_TURNS = 2;

/* ---------- Board data (32 slots) ---------- */
const PLAYABLE = [
  {type:'corner', name:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô'},
  {type:'property', name:'‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏≠‡∏•‡∏ü‡πå', buy:100, rent:20, upHouse:200, upHotel:400},
  {type:'treasure', name:'‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô'},
  {type:'property', name:'‡∏õ‡πà‡∏≤‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏°‡∏ô‡∏ï‡∏£‡πå', buy:120, rent:24, upHouse:200, upHotel:400},
  {type:'fate', name:'‡∏î‡∏ß‡∏á‡∏î‡∏µ-‡∏î‡∏ß‡∏á‡∏£‡πâ‡∏≤‡∏¢'},
  {type:'property', name:'‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Ñ‡∏£‡∏∞', buy:160, rent:32, upHouse:220, upHotel:420},
  {type:'taxsmall', name:'‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡πà‡∏≠‡∏¢', amount:100},
  {type:'property', name:'‡∏™‡∏ß‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•', buy:220, rent:44, upHouse:260, upHotel:460},
  {type:'corner', name:'‡∏Ñ‡∏∏‡∏Å'},
  {type:'property', name:'‡∏õ‡πà‡∏≤‡πÄ‡∏´‡πá‡∏î‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á', buy:300, rent:56, upHouse:280, upHotel:480},
  {type:'treasure', name:'‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô'},
  {type:'property', name:'‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏•‡∏ü‡πå', buy:280, rent:52, upHouse:280, upHotel:480},
  {type:'fate', name:'‡∏î‡∏ß‡∏á‡∏î‡∏µ-‡∏î‡∏ß‡∏á‡∏£‡πâ‡∏≤‡∏¢'},
  {type:'property', name:'‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏¥‡∏ô‡πÇ‡∏ö‡∏£‡∏≤‡∏ì', buy:180, rent:36, upHouse:240, upHotel:440},
  {type:'taxsmall', name:'‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡πà‡∏≠‡∏¢', amount:120},
  {type:'property', name:'‡∏ñ‡πâ‡∏≥‡∏°‡∏±‡∏á‡∏Å‡∏£', buy:260, rent:48, upHouse:260, upHotel:460},
  {type:'corner', name:'‡∏†‡∏≤‡∏©‡∏µ‡πÉ‡∏´‡∏ç‡πà', amount:300},
  {type:'property', name:'‡∏ö‡πà‡∏≠‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•', buy:480, rent:92, upHouse:380, upHotel:580},
  {type:'property', name:'‡∏™‡∏ß‡∏ô‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö', buy:360, rent:68, upHouse:320, upHotel:520},
  {type:'fate', name:'‡∏î‡∏ß‡∏á‡∏î‡∏µ-‡∏î‡∏ß‡∏á‡∏£‡πâ‡∏≤‡∏¢'},
  {type:'property', name:'‡∏Ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏ô‡πÅ‡∏Ñ‡∏£‡∏∞', buy:340, rent:64, upHouse:300, upHotel:500},
  {type:'treasure', name:'‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô'},
  {type:'property', name:'‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô', buy:380, rent:72, upHouse:320, upHotel:520},
  {type:'taxsmall', name:'‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡πà‡∏≠‡∏¢', amount:120},
  {type:'corner', name:'‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏´‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏±‡πâ‡∏ô'},
  {type:'property', name:'‡∏ï‡∏•‡∏≤‡∏î‡∏•‡∏±‡∏ö', buy:400, rent:76, upHouse:340, upHotel:540},
  {type:'property', name:'‡∏Ñ‡πà‡∏≤‡∏¢‡∏ô‡∏±‡∏Å‡∏£‡∏ö', buy:440, rent:84, upHouse:360, upHotel:560},
  {type:'property', name:'‡∏ñ‡πâ‡∏≥‡∏´‡∏¥‡∏ô‡∏°‡∏≤‡∏ô‡∏≤', buy:500, rent:96, upHouse:380, upHotel:580},
  {type:'treasure', name:'‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô'},
  {type:'property', name:'‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏™‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', buy:560, rent:120, upHouse:420, upHotel:620},
  {type:'fate', name:'‡∏î‡∏ß‡∏á‡∏î‡∏µ-‡∏î‡∏ß‡∏á‡∏£‡πâ‡∏≤‡∏¢'},
  {type:'property', name:'‡∏õ‡πà‡∏≤‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå', buy:540, rent:110, upHouse:400, upHotel:600}
];

/* ---------- Cards ---------- */
const TREASURE_CARDS = [
  {text:'‡πÄ‡∏à‡∏≠‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ +150', type:'money', amount:150},
  {text:'‡∏ç‡∏≤‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç +100', type:'money', amount:100},
  {text:'‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ 1 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô)', type:'coupon', amount:1},
  {text:'‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á -60', type:'money', amount:-60},
  {text:'‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ +180', type:'money', amount:180},
  {text:'‡∏û‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤ +200', type:'money', amount:200},
  {text:'‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î -40', type:'money', amount:-40},
  {text:'‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á +150', type:'money', amount:150}
];
const FATE_CARDS = [
  {text:'‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà +400', type:'money', amount:400},
  {text:'‡πÇ‡∏î‡∏ô‡πÇ‡∏à‡∏£‡∏ã‡∏∏‡πà‡∏°‡∏à‡∏π‡πà‡πÇ‡∏à‡∏° -200', type:'money', amount:-200},
  {text:'‡∏£‡∏ñ‡∏û‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ -150', type:'money', amount:-150},
  {text:'‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡∏∏‡∏Å', type:'jail'},
  {text:'‡∏û‡∏ö‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î ‡πÑ‡∏õ Start (‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™)', type:'move', to:0},
  {text:'‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏£‡∏î‡∏Å +250', type:'money', amount:250},
  {text:'‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö -300', type:'money', amount:-300},
  {text:'‡∏û‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤ +300', type:'money', amount:300}
];

/* ---------- Game state ---------- */
const state = {
  players:[
    {id:1,name:'‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',pos:0,money:INITIAL_MONEY,skip:0,coupons:0,ai:false,hasPassedStart:false},
    {id:2,name:'AI',pos:0,money:INITIAL_MONEY,skip:0,coupons:0,ai:true,hasPassedStart:false}
  ],
  current:0,
  owned:{}, // pos -> ownerIndex
  houses:{}, // pos -> 0/1/2
  treasureDeck:[],
  fateDeck:[],
  logs:[],
  animating:false
};

/* ---------- Helpers ---------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function log(msg){ state.logs.unshift(msg); renderLog(); }
function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

/* ---------- UI refs ---------- */
const boardEl = document.getElementById('board');
const centerNote = document.getElementById('centerNote');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalOk = document.getElementById('modal-ok');
const modalCancel = document.getElementById('modal-cancel');
const currentPlayerEl = document.getElementById('currentPlayer');
const statusEl = document.getElementById('status');
const playersEl = document.getElementById('players');
const propListEl = document.getElementById('propList');
const logEl = document.getElementById('log');
const die1El = document.getElementById('die1');
const die2El = document.getElementById('die2');

const startBtn = document.getElementById('startBtn');
const rollBtn = document.getElementById('rollBtn');
const endBtn = document.getElementById('endBtn');
const buyBtn = document.getElementById('buyBtn');
const upgradeBtn = document.getElementById('upgradeBtn');
const freeTripBtn = document.getElementById('freeTripBtn');

/* ---------- Build board (9x9) and map playable slots (32) ---------- */
function buildBoard(){
  boardEl.innerHTML='';
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const div = document.createElement('div');
      div.className='cell';
      if(r>0 && r<8 && c>0 && c<8) div.classList.add('blank');
      boardEl.appendChild(div);
    }
  }
  const coords=[];
  for(let c=0;c<9;c++) coords.push({r:0,c});
  for(let r=1;r<8;r++) coords.push({r,c:8});
  for(let c=8;c>=0;c--) coords.push({r:8,c});
  for(let r=7;r>0;r--) coords.push({r,c:0});
  const children = Array.from(boardEl.children);
  for(let i=0;i<PLAYABLE.length;i++){
    const tile = PLAYABLE[i];
    const coord = coords[i];
    const idx = coord.r*9 + coord.c;
    const cell = children[idx];
    cell.dataset.slot = i;
    cell.innerHTML = '';
    cell.classList.remove('corner');
    if(tile.type==='corner'){
      cell.classList.add('corner');
      const t = document.createElement('div'); t.textContent = tile.name; t.style.fontWeight='700'; cell.appendChild(t);
      if(tile.amount){ const a=document.createElement('div'); a.className='small'; a.textContent = `‡∏à‡πà‡∏≤‡∏¢ ${tile.amount}`; cell.appendChild(a); }
    } else if(tile.type==='property'){
      cell.classList.add('property');
      const t = document.createElement('div'); t.className='title'; t.textContent = tile.name; cell.appendChild(t);
      const p = document.createElement('div'); p.className='price'; p.textContent = `‡∏ã‡∏∑‡πâ‡∏≠ ${tile.buy} | ‡πÄ‡∏ä‡πà‡∏≤ ${tile.rent}`; cell.appendChild(p);
    } else {
      const t = document.createElement('div'); t.className='title'; t.textContent = tile.name; cell.appendChild(t);
      if(tile.type==='taxsmall'){ const p=document.createElement('div'); p.className='price'; p.textContent = `‡∏à‡πà‡∏≤‡∏¢ ${tile.amount}`; cell.appendChild(p); }
    }
    cell.addEventListener('click', ()=> onClickSlot(i));
  }
}

/* ---------- Rendering ---------- */
function renderPlayers(){
  playersEl.innerHTML='';
  state.players.forEach((p,idx)=>{
    const div = document.createElement('div'); div.className='player';
    const ownerCount = Object.values(state.owned).filter(v=>v===idx).length;
    div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div class='token ${idx===0?'p1':'p2'}'>${idx+1}</div>
      <div><div style="font-weight:700">${p.name}${p.ai?' (AI)':''}</div><div class="small">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:${p.pos+1} | ‡πÄ‡∏á‡∏¥‡∏ô:${p.money}</div></div></div>
      <div style="text-align:right"><div class="small">‡∏ú‡πà‡∏≤‡∏ôStart:${p.hasPassedStart} | ‡∏á‡∏î:${p.skip} | ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á:${p.coupons} | ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô:${ownerCount}</div></div>`;
    playersEl.appendChild(div);
  });
}

function renderProps(){
  propListEl.innerHTML='';
  PLAYABLE.forEach((t,i)=>{
    if(t.type!=='property') return;
    const owner = state.owned[i]!==undefined?`‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô${state.owned[i]+1}`:'-';
    const house = state.houses[i]===1?'‡∏ö‡πâ‡∏≤‡∏ô': state.houses[i]===2?'‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°':'-';
    const d = document.createElement('div'); d.className='prop-item';
    d.textContent = `${i+1}. ${t.name} | ‡∏ã‡∏∑‡πâ‡∏≠:${t.buy} | ‡πÄ‡∏ä‡πà‡∏≤:${t.rent} | ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:${owner} | ${house}`;
    propListEl.appendChild(d);
  });
}

function renderTokensAndMarks(){
  boardEl.querySelectorAll('.cell').forEach(c=>{
    const t = c.querySelector('.tokens'); if(t) t.remove();
    const o = c.querySelector('.owner-mark'); if(o) o.remove();
    const h = c.querySelector('.house-mark'); if(h) h.remove();
  });
  Object.keys(state.owned).forEach(k=>{
    const pos = Number(k);
    const ownerIdx = state.owned[pos];
    const cel = boardEl.querySelector(`.cell[data-slot='${pos}']`);
    if(!cel) return;
    const mark = document.createElement('div'); mark.className='owner-mark'; mark.textContent = `P${ownerIdx+1}`;
    cel.appendChild(mark);
    if(state.houses[pos]===1){ const hm=document.createElement('div'); hm.className='house-mark'; hm.textContent='üè†'; cel.appendChild(hm); }
    else if(state.houses[pos]===2){ const hm=document.createElement('div'); hm.className='house-mark'; hm.textContent='üè∞'; cel.appendChild(hm); }
  });
  state.players.forEach((p,idx)=>{
    const cel = boardEl.querySelector(`.cell[data-slot='${p.pos}']`);
    if(!cel) return;
    let wrap = cel.querySelector('.tokens');
    if(!wrap){ wrap = document.createElement('div'); wrap.className='tokens'; cel.appendChild(wrap); }
    const token = document.createElement('div'); token.className='token ' + (idx===0?'p1':'p2'); token.textContent = idx+1;
    wrap.appendChild(token);
  });
}

function renderLog(){ logEl.innerHTML=''; state.logs.forEach(s=>{ const d=document.createElement('div'); d.textContent=s; logEl.appendChild(d); }); }

function refreshUI(){
  currentPlayerEl.textContent = state.players[state.current].name + (state.players[state.current].ai ? ' (AI)':'');
  statusEl.textContent = `‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ${state.current+1}`;
  renderPlayers(); renderProps(); renderLog(); renderTokensAndMarks();
}

/* ---------- Modal helpers ---------- */
function showModal(title, body, okText='‡∏ï‡∏Å‡∏•‡∏á', cancelText=null, onOk=null, onCancel=null){
  modalTitle.textContent = title;
  modalBody.textContent = body;
  modal.style.display = 'flex';
  modalOk.textContent = okText;
  if(cancelText){ modalCancel.style.display='inline-block'; modalCancel.textContent = cancelText; }
  else { modalCancel.style.display='none'; }
  modalOk.onclick = ()=>{ modal.style.display='none'; if(onOk) onOk(); };
  modalCancel.onclick = ()=>{ modal.style.display='none'; if(onCancel) onCancel(); };
}

/* ---------- Movement & Start bonuses ---------- */
function rollTwoDice(){ return [Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1]; }

async function animateMoveAndResolve(playerIdx, steps){
  if(state.animating) return;
  state.animating = true;
  const p = state.players[playerIdx];
  const prev = p.pos;
  let passed = false;
  for(let i=0;i<steps;i++){
    p.pos = (p.pos + 1) % PLAYABLE.length;
    renderTokensAndMarks();
    // detect pass (if previous > current)
    if(prev <= PLAYABLE.length-1 && prev > p.pos) passed = true;
    await sleep(ANIM_STEP_MS);
  }
  // landing on Start
  if(p.pos === 0){
    p.money += START_BONUS_LAND;
    p.hasPassedStart = true;
    log(`${p.name} ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÑ‡∏î‡πâ +${START_BONUS_LAND}`);
    await new Promise(res=> showModal('‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', `${p.name} ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${START_BONUS_LAND} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
  } else if(passed){
    p.money += START_BONUS_PASS;
    p.hasPassedStart = true;
    log(`${p.name} ‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÑ‡∏î‡πâ +${START_BONUS_PASS}`);
    await new Promise(res=> showModal('‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', `${p.name} ‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${START_BONUS_PASS} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
  }
  log(`${p.name} ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á ${p.pos+1} ‚Äî ${PLAYABLE[p.pos].name}`);
  await handleLanding(p.pos);
  refreshUI();
  state.animating = false;
}

/* ---------- Landing effects ---------- */
async function handleLanding(pos){
  const tile = PLAYABLE[pos];
  const pIdx = state.current;
  const p = state.players[pIdx];

  if(tile.type==='property'){
    if(state.owned[pos]===undefined){
      log(`${tile.name} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á`);
      if(p.hasPassedStart){
        // ask buy
        await new Promise(res=> showModal('‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏ß‡πà‡∏≤‡∏á', `${tile.name}\n‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠: ${tile.buy}\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏°?`, '‡∏ã‡∏∑‡πâ‡∏≠', '‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠', ()=>{
          if(p.money < tile.buy){ showModal('‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏ï‡∏Å‡∏•‡∏á'); res(); return; }
          p.money -= tile.buy; state.owned[pos] = pIdx; state.houses[pos] = 0;
          log(`${p.name} ‡∏ã‡∏∑‡πâ‡∏≠ ${tile.name} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${tile.buy}`); refreshUI(); res();
        }, ()=>{ res(); }));
      } else {
        await new Promise(res=> showModal('‡∏¢‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠', '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
      }
    } else if(state.owned[pos] !== pIdx){
      const owner = state.owned[pos];
      let charge = tile.rent;
      if(state.houses[pos]===1) charge = Math.floor(tile.rent * 2.5);
      if(state.houses[pos]===2) charge = Math.floor(tile.rent * 5);
      p.money -= charge; state.players[owner].money += charge;
      log(`${p.name} ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ ${charge} ‡πÉ‡∏´‡πâ ${state.players[owner].name}`);
      await new Promise(res=> showModal('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤', `${p.name} ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ ${charge} ‡πÉ‡∏´‡πâ ${state.players[owner].name}`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
    } else {
      await new Promise(res=> showModal('‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', `${tile.name} ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
    }
  } else if(tile.type==='treasure'){
    const card = drawTreasureCard();
    log(`${p.name} ‡πÑ‡∏î‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥: ${card.text}`);
    await new Promise(res=> showModal('‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', card.text, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ applyCard(card); res(); }));
  } else if(tile.type==='fate'){
    const card = drawFateCard();
    log(`${p.name} ‡πÑ‡∏î‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡∏ß‡∏á: ${card.text}`);
    await new Promise(res=> showModal('‡∏î‡∏ß‡∏á‡∏î‡∏µ-‡∏î‡∏ß‡∏á‡∏£‡πâ‡∏≤‡∏¢', card.text, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ applyCard(card); res(); }));
  } else if(tile.type==='taxsmall'){
    p.money -= tile.amount;
    log(`${p.name} ‡∏à‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡πà‡∏≠‡∏¢ ${tile.amount}`);
    await new Promise(res=> showModal('‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡πà‡∏≠‡∏¢', `${p.name} ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡πà‡∏≠‡∏¢ ${tile.amount} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
  } else if(tile.type==='corner'){
    if(tile.name==='‡∏Ñ‡∏∏‡∏Å'){
      p.skip = JAIL_TURNS;
      log(`${p.name} ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏±‡∏á ‡∏á‡∏î‡πÄ‡∏•‡πà‡∏ô ${JAIL_TURNS} ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô`);
      await new Promise(res=> showModal('‡∏Ñ‡∏∏‡∏Å', `${p.name} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏∏‡∏Å ‡∏á‡∏î‡πÄ‡∏•‡πà‡∏ô ${JAIL_TURNS} ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
    } else if(tile.name==='‡∏†‡∏≤‡∏©‡∏µ‡πÉ‡∏´‡∏ç‡πà'){
      p.money -= tile.amount;
      log(`${p.name} ‡∏à‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡πÉ‡∏´‡∏ç‡πà ${tile.amount}`);
      await new Promise(res=> showModal('‡∏†‡∏≤‡∏©‡∏µ‡πÉ‡∏´‡∏ç‡πà', `${p.name} ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏µ ${tile.amount} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
    } else if(tile.name==='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏´‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏±‡πâ‡∏ô'){
      await new Promise(res=> showModal('‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', `${p.name} ‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‚Äî ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ res(); }));
    }
  }
  refreshUI();
  checkBankruptcy();
}

/* ---------- Cards operations ---------- */
function drawTreasureCard(){ if(state.treasureDeck.length===0) state.treasureDeck = shuffle([...TREASURE_CARDS]); return state.treasureDeck.pop(); }
function drawFateCard(){ if(state.fateDeck.length===0) state.fateDeck = shuffle([...FATE_CARDS]); return state.fateDeck.pop(); }

function applyCard(card){
  const p = state.players[state.current];
  if(card.type==='money'){ p.money += card.amount; log(`${p.name} ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${card.amount} => ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.money}`); }
  else if(card.type==='coupon'){ p.coupons += card.amount; log(`${p.name} ‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ${card.amount}`); }
  else if(card.type==='move'){ p.pos = card.to; log(`${p.name} ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á ${card.to+1} (${PLAYABLE[card.to].name})`); if(card.to===0){ p.money += START_BONUS_LAND; p.hasPassedStart=true; log(`${p.name} ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà Start ‡πÑ‡∏î‡πâ +${START_BONUS_LAND}`); } handleLanding(p.pos); }
  else if(card.type==='jail'){ p.pos = 8; p.skip = JAIL_TURNS; log(`${p.name} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏∏‡∏Å ‡∏á‡∏î‡πÄ‡∏•‡πà‡∏ô ${JAIL_TURNS} ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô`); }
  refreshUI();
}

/* ---------- Buy & Upgrade (buttons) ---------- */
function buyCurrent(){
  const p = state.players[state.current];
  const pos = p.pos;
  const tile = PLAYABLE[pos];
  if(tile.type!=='property'){ alert('‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); return; }
  if(state.owned[pos] !== undefined){ alert('‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); return; }
  if(!p.hasPassedStart){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô Start ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠'); return; }
  if(p.money < tile.buy){ alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
  p.money -= tile.buy; state.owned[pos] = state.current; state.houses[pos] = 0;
  log(`${p.name} ‡∏ã‡∏∑‡πâ‡∏≠ ${tile.name} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${tile.buy}`);
  showModal('‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `${p.name} ‡∏ã‡∏∑‡πâ‡∏≠ ${tile.name} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${tile.buy}`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ refreshUI(); });
  refreshUI();
}

function upgradeCurrent(){
  const p = state.players[state.current];
  const pos = p.pos;
  const tile = PLAYABLE[pos];
  if(tile.type!=='property'){ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); return; }
  if(state.owned[pos] !== state.current){ alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á'); return; }
  const h = state.houses[pos] || 0;
  if(h===0){
    if(p.money < tile.upHouse){ alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    p.money -= tile.upHouse; state.houses[pos] = 1;
    log(`${p.name} ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${tile.name} ‡∏à‡πà‡∏≤‡∏¢ ${tile.upHouse}`);
    showModal('‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á', `${p.name} ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${tile.name}`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ refreshUI(); });
  } else if(h===1){
    if(p.money < tile.upHotel){ alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    p.money -= tile.upHotel; state.houses[pos] = 2;
    log(`${p.name} ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏ó‡∏µ‡πà ${tile.name} ‡∏à‡πà‡∏≤‡∏¢ ${tile.upHotel}`);
    showModal('‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î', `${p.name} ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ${tile.name} ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ refreshUI(); });
  } else {
    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß');
  }
  refreshUI();
}

/* ---------- Free Trip ---------- */
function freeTrip(){
  const p = state.players[state.current];
  const list = PLAYABLE.map((t,i)=> `${i+1}:${t.name}`).join('\n');
  const sel = prompt('‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ (1-' + PLAYABLE.length + ')\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\n' + list);
  const idx = Number(sel)-1;
  if(isNaN(idx) || idx<0 || idx>=PLAYABLE.length){ alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
  p.pos = idx; log(`${p.name} ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${idx+1} (${PLAYABLE[idx].name})`);
  if(idx===0){ p.money += START_BONUS_LAND; p.hasPassedStart=true; log(`${p.name} ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà Start ‡πÑ‡∏î‡πâ +${START_BONUS_LAND}`); }
  handleLanding(p.pos); refreshUI();
}

/* ---------- Bankruptcy ---------- */
function checkBankruptcy(){
  for(const p of state.players){
    if(p.money < 0){
      showModal('‡∏à‡∏ö‡πÄ‡∏Å‡∏°', `${p.name} ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÄ‡∏Å‡∏°‡∏à‡∏ö`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ disableAll(); });
      log(`${p.name} ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß`);
      return true;
    }
  }
  return false;
}
function disableAll(){
  rollBtn.disabled = true; buyBtn.disabled = true; upgradeBtn.disabled = true; endBtn.disabled = true; freeTripBtn.disabled = true;
}

/* ---------- Turn flow: player must press End Turn to let AI play ---------- */
async function playerRoll(){
  if(state.animating) return;
  const cur = state.current;
  const p = state.players[cur];
  if(p.ai){ alert('‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô'); return; }
  if(p.skip>0){ p.skip--; log(`${p.name} ‡∏á‡∏î‡πÄ‡∏•‡πà‡∏ô ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.skip} ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô`); refreshUI(); return; }

  const [d1,d2] = rollTwoDice();
  die1El.textContent = d1; die2El.textContent = d2;
  log(`${p.name} ‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${d1} + ${d2} = ${d1+d2}`);

  await animateMoveAndResolve(cur, d1+d2);

  const tile = PLAYABLE[p.pos];
  if(tile.type==='property'){
    buyBtn.disabled = false;
    upgradeBtn.disabled = (state.owned[p.pos] !== state.current);
  } else {
    buyBtn.disabled = true; upgradeBtn.disabled = true;
  }

  // lock roll, enable End Turn
  rollBtn.disabled = true;
  endBtn.disabled = false;
}

function endTurnPressed(){
  // player presses to hand to AI
  endBtn.disabled = true;
  buyBtn.disabled = true;
  upgradeBtn.disabled = true;
  rollBtn.disabled = true;
  state.current = (state.current + 1) % state.players.length;
  log(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${state.players[state.current].name}`);
  refreshUI();
  if(state.players[state.current].ai){
    setTimeout(()=> aiPlay(), 400);
  } else {
    rollBtn.disabled = false;
  }
}

async function aiPlay(){
  const aiIdx = state.current;
  const ai = state.players[aiIdx];
  if(ai.skip>0){ ai.skip--; log(`${ai.name} (AI) ‡∏á‡∏î‡πÄ‡∏•‡πà‡∏ô ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${ai.skip} ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô`); refreshUI(); endTurnToPlayer(); return; }
  await sleep(400);
  const [d1,d2] = rollTwoDice();
  die1El.textContent = d1; die2El.textContent = d2;
  log(`${ai.name} (AI) ‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${d1} + ${d2} = ${d1+d2}`);
  await animateMoveAndResolve(aiIdx, d1+d2);

  // AI decision
  const pos = ai.pos;
  const tile = PLAYABLE[pos];
  if(tile.type==='property' && state.owned[pos]===undefined && ai.hasPassedStart){
    const reserve = 300;
    if(ai.money > tile.buy + reserve){
      ai.money -= tile.buy; state.owned[pos]=aiIdx; state.houses[pos]=0;
      log(`${ai.name} (AI) ‡∏ã‡∏∑‡πâ‡∏≠ ${tile.name} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${tile.buy}`);
      showModal('AI ‡∏ã‡∏∑‡πâ‡∏≠', `${ai.name} ‡∏ã‡∏∑‡πâ‡∏≠ ${tile.name}`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ refreshUI(); });
    }
  }
  const h = state.houses[pos] || 0;
  if(tile.type==='property' && state.owned[pos]===aiIdx){
    if(h===0 && ai.money > (tile.upHouse||200) + 200){ ai.money -= tile.upHouse||200; state.houses[pos]=1; log(`${ai.name} (AI) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô`); }
    else if(h===1 && ai.money > (tile.upHotel||400) + 300){ ai.money -= tile.upHotel||400; state.houses[pos]=2; log(`${ai.name} (AI) ‡∏≠‡∏±‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°`); }
  }
  refreshUI();
  checkBankruptcy();
  setTimeout(()=> endTurnToPlayer(), 700);
}

function endTurnToPlayer(){
  const humanIdx = state.players.findIndex(p=>!p.ai);
  state.current = humanIdx;
  log(`‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ${state.players[state.current].name}`);
  rollBtn.disabled = false;
  endBtn.disabled = true;
  refreshUI();
}

/* ---------- Click handlers & wiring ---------- */
startBtn.addEventListener('click', ()=>{
  state.players.forEach(p=>{ p.pos=0; p.money=INITIAL_MONEY; p.skip=0; p.coupons=0; p.hasPassedStart=false; });
  state.current = 0;
  state.owned = {}; state.houses = {}; state.logs = []; state.treasureDeck = shuffle([...TREASURE_CARDS]); state.fateDeck = shuffle([...FATE_CARDS]);
  buildBoard(); refreshUI();
  die1El.textContent='-'; die2El.textContent='-';
  rollBtn.disabled = false; endBtn.disabled = true; buyBtn.disabled = true; upgradeBtn.disabled = true; freeTripBtn.disabled = false;
  log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ' + INITIAL_MONEY);
});

rollBtn.addEventListener('click', ()=> playerRoll());
endBtn.addEventListener('click', ()=> endTurnPressed());
buyBtn.addEventListener('click', ()=> buyCurrent());
upgradeBtn.addEventListener('click', ()=> upgradeCurrent());
freeTripBtn.addEventListener('click', ()=> freeTrip());

modalOk.addEventListener('click', ()=> { modal.style.display='none'; });
modalCancel.addEventListener('click', ()=> { modal.style.display='none'; });

// click slot info
function onClickSlot(idx){
  const tile = PLAYABLE[idx];
  let info = `${idx+1}. ${tile.name}\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${tile.type}`;
  if(tile.type==='property') info += `\n‡∏£‡∏≤‡∏Ñ‡∏≤: ${tile.buy} | ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤: ${tile.rent}\n‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô: ${tile.upHouse} | ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°: ${tile.upHotel}`;
  if(tile.type==='taxsmall') info += `\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${tile.amount}`;
  alert(info);
}

/* ---------- Utility ---------- */
function renderLog(){ logEl.innerHTML=''; state.logs.forEach(s=>{ const d=document.createElement('div'); d.textContent = s; logEl.appendChild(d); }); }
function refreshUI(){ currentPlayerEl.textContent = state.players[state.current].name + (state.players[state.current].ai ? ' (AI)':''); statusEl.textContent = `‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ${state.current+1}`; renderPlayers(); renderProps(); renderLog(); renderTokensAndMarks(); }
function checkBankruptcy(){ for(const p of state.players){ if(p.money < 0){ showModal('‡∏à‡∏ö‡πÄ‡∏Å‡∏°', `${p.name} ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÄ‡∏Å‡∏°‡∏à‡∏ö`, '‡∏ï‡∏Å‡∏•‡∏á', null, ()=>{ disableAll(); }); log(`${p.name} ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß`); return true; } } return false; }

buildBoard();
state.treasureDeck = shuffle([...TREASURE_CARDS]); state.fateDeck = shuffle([...FATE_CARDS]);
refreshUI();
log('‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Äî ‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô');
</script>
</body>
</html>
